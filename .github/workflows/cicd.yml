name: CI/CD para EC2 pÃºblica e privada

on:
  push:
    branches:
      - main       # Branch principal do projeto
      - master     # Manter por compatibilidade
  workflow_dispatch: # Permite execuÃ§Ã£o manual do workflow
    inputs:
      environment:
        description: 'Ambiente para deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development
      skip_tests:
        description: 'Pular testes?'
        required: false
        default: true
        type: boolean
      force_restart:
        description: 'ForÃ§ar restart mesmo se nÃ£o houver mudanÃ§as?'
        required: false
        default: false
        type: boolean

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      # 0. Exibir informaÃ§Ãµes do trigger
      - name: ğŸ“‹ InformaÃ§Ãµes do Deploy
        run: |
          echo "ğŸš€ ========================================="
          echo "ğŸ“ RepositÃ³rio: ${{ github.repository }}"
          echo "ğŸ“Œ Branch: ${{ github.ref_name }}"
          echo "ğŸ”— Trigger: ${{ github.event_name }}"
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ğŸ® EXECUÃ‡ÃƒO MANUAL"
            echo "  â€¢ Ambiente: ${{ github.event.inputs.environment }}"
            echo "  â€¢ Pular testes: ${{ github.event.inputs.skip_tests }}"
            echo "  â€¢ ForÃ§ar restart: ${{ github.event.inputs.force_restart }}"
          else
            echo "âš™ï¸ EXECUÃ‡ÃƒO AUTOMÃTICA (Push)"
          fi
          
          echo "âœ¨ ========================================="

      # 1. Checkout do repositÃ³rio
      - name: BE - Checkout do CÃ³digo
        uses: actions/checkout@v4

      # 2. Configurar JDK
      - name: BE - Configurar JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'
          
          cache-dependency-path: 'beiramar.api/pom.xml'
      
      # 3. Configurar variÃ¡veis de ambiente no application.properties
      - name: BE - Configurar Banco de Dados e CORS no application.properties
        run: |
          echo "ğŸ“„ ConteÃºdo atual de application.properties:"
          cat src/main/resources/application.properties | head -20
          echo "... (truncado)"
          echo ""
          echo "==========================================="
          echo ""
          
          # Substituir ou adicionar spring.datasource.url
          echo "ğŸ”§ Atualizando spring.datasource.url..."
          if grep -q "^spring.datasource.url=" src/main/resources/application.properties; then
            sed -i "s|^spring.datasource.url=.*|spring.datasource.url=jdbc:mysql://${{ secrets.DB_HOST }}:3306/beiramar?useSSL=false\&allowPublicKeyRetrieval=true|g" src/main/resources/application.properties
            echo "âœ… spring.datasource.url atualizado"
          else
            echo "spring.datasource.url=jdbc:mysql://${{ secrets.DB_HOST }}:3306/beiramar?useSSL=false\&allowPublicKeyRetrieval=true" >> src/main/resources/application.properties
            echo "âœ… spring.datasource.url adicionado"
          fi
          
          # Substituir ou adicionar cors.allowed.origins
          echo "ğŸ”§ Atualizando cors.allowed.origins..."
          if grep -q "^cors.allowed.origins=" src/main/resources/application.properties; then
            sed -i "s|^cors.allowed.origins=.*|cors.allowed.origins=http://${{ secrets.ALB_DNS_NAME }}|g" src/main/resources/application.properties
            echo "âœ… cors.allowed.origins atualizado"
          else
            echo "cors.allowed.origins=http://${{ secrets.ALB_DNS_NAME }}" >> src/main/resources/application.properties
            echo "âœ… cors.allowed.origins adicionado"
          fi
          
          echo ""
          echo "ğŸ“‹ Valores configurados:"
          echo "---"
          grep "^spring.datasource.url=" src/main/resources/application.properties || echo "âš ï¸ spring.datasource.url nÃ£o encontrado"
          grep "^cors.allowed.origins=" src/main/resources/application.properties || echo "âš ï¸ cors.allowed.origins nÃ£o encontrado"
          echo "---"
          echo "âœ¨ ConfiguraÃ§Ã£o concluÃ­da com sucesso!"
        working-directory: ./beiramar.api

      # 4. Gerar Artefato .JAR
      - name: BE - Gerar Artefato .JAR
        run: mvn clean package -DskipTests=true -Dmaven.test.skip=true
        working-directory: ./beiramar.api

      # 5. Renomear JAR para nome fixo
      - name: BE - Renomear JAR para beiramar-api.jar
        run: |
          JAR_NAME=$(ls target/*.jar)
          mv $JAR_NAME target/beiramar-api.jar
          echo "Renomeado para: target/beiramar-api.jar"
        working-directory: ./beiramar.api

      # 6. DiagnÃ³stico de Conectividade
      - name: ğŸ” DiagnÃ³stico - Verificar Conectividade SSH
        run: |
          echo "ğŸ” ========================================="
          echo "InformaÃ§Ãµes da ConexÃ£o SSH:"
          echo "  â€¢ Host: ${{ secrets.BACKEND_HOST }}"
          echo "  â€¢ User: ${{ secrets.BACKEND_USER }}"
          echo "  â€¢ Port: 22"
          echo ""
          echo "Detalhes do Arquivo:"
          JAR_PATH="./beiramar.api/target/beiramar-api.jar"
          if [ -f "$JAR_PATH" ]; then
            ls -lh "$JAR_PATH"
            echo "  âœ… JAR encontrado"
          else
            echo "  âŒ JAR nÃ£o encontrado"
          fi
          echo "ğŸ” ========================================="
          echo ""
          echo "Nota: Se o SCP falhar com 'timeout', verifique:"
          echo "  1. BACKEND_HOST Ã© um IP pÃºblico (nÃ£o privado 10.x.x.x)?"
          echo "  2. Security Group permite SSH (porta 22)?"
          echo "  3. EC2 estÃ¡ em estado 'running'?"
          echo "  4. Chave SSH (EC2_SSH_KEY) estÃ¡ correta?"
          echo ""
          echo "Ver 'SSH_TIMEOUT_FIX.md' para soluÃ§Ãµes detalhadas"

      # 6.5 Preparar chave SSH
      - name: ğŸ”‘ Preparar Chave SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.BACKEND_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      # 7. Copiar JAR e Reiniciar via SSH
      - name: BE - Copiar JAR e Reiniciar AplicaÃ§Ã£o
        run: |
          set -e
          
          SSH_CMD="ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ secrets.BACKEND_USER }}@${{ secrets.BACKEND_HOST }}"
          
          echo "ğŸ“¦ Copiando JAR via SCP..."
          scp -i ~/.ssh/deploy_key -o ConnectTimeout=10 \
            ./beiramar.api/target/beiramar-api.jar \
            ${{ secrets.BACKEND_USER }}@${{ secrets.BACKEND_HOST }}:/tmp/beiramar-api.jar
          
          echo "âœ… JAR copiado com sucesso!"
          
          echo "ğŸš€ Executando deploy remoto..."
          $SSH_CMD << 'EOSSH'
          set -e
          
          echo "ğŸ“¦ Verificando arquivo copiado..."
          ls -lh /tmp/beiramar-api.jar
          
          echo "ğŸš€ Movendo JAR para o diretÃ³rio de aplicaÃ§Ã£o..."
          sudo mv /tmp/beiramar-api.jar /usr/share/api/beiramar-api.jar || \
            { echo "Criando diretÃ³rio..."; sudo mkdir -p /usr/share/api; sudo mv /tmp/beiramar-api.jar /usr/share/api/beiramar-api.jar; }
          sudo chmod 644 /usr/share/api/beiramar-api.jar
          
          echo "ğŸ›‘ Parando containers..."
          cd /home/ubuntu || cd /home/ec2-user || cd ~
          sudo docker-compose -f compose.yaml down 2>/dev/null || echo "Nenhum container rodando"
          
          echo "ğŸ”„ Recriando e iniciando containers com novo JAR..."
          sudo docker-compose -f compose.yaml up -d --force-recreate
          
          echo "â³ Aguardando inicializaÃ§Ã£o..."
            sleep 10
            
            echo "âœ… Verificando status dos containers..."
            sudo docker-compose -f compose.yaml ps
            
            echo "ğŸ‰ AplicaÃ§Ã£o reiniciada com sucesso!"
            echo "ğŸ“ Acesse em: http://${{ secrets.ALB_DNS_NAME }}/api"