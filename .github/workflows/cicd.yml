name: CI/CD para EC2 pública e privada

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout do Repositório
        uses: actions/checkout@v4

      # 2. Debug
      - name: DEBUG - Mostrar diretórios
        run: |
          pwd
          ls -R .

      # 3. JDK + Maven
      - name: BE - Configurar JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      # 4. Criar pasta backend na EC2 pública
      - name: BE - Criar pasta backend no servidor público
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            mkdir -p /home/${{ secrets.REMOTE_USER }}/backend
            chown -R ${{ secrets.REMOTE_USER }} /home/${{ secrets.REMOTE_USER }}/backend

      # 5. Gerar JAR
      - name: BE - Gerar Artefato .JAR
        run: mvn clean package -DskipTests=true -Dmaven.test.skip=true
        working-directory: ./beiramar.api

      # 6. Renomear JAR
      - name: BE - Renomear JAR para app_loko.jar
        run: |
          mv ./target/beiramar.api-0.0.1-SNAPSHOT.jar ./target/app_loko.jar
          
          echo "Verificação do arquivo a ser enviado:"
          ls -lh ./target/app_loko.jar
        working-directory: ./beiramar.api


      # 7. Deploy para EC2 pública via rsync
      - name: BE - Copiar arquivos e Deploy para EC2 pública
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          TARGET: /home/${{ secrets.REMOTE_USER }}/backend
          ARGS: "-rltgoDzvO --delete"
          SOURCE: "./beiramar.api/target/app_loko.jar"

      # 8. Copiar JAR da pública → privada e reiniciar serviços
      - name: BE - Enviar JAR da pública para a privada e reiniciar serviços
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            ssh-keygen -R ${{ secrets.REMOTE_HOST_PRIVADO }}

            # Criar chave temporária
            ARQUIVO_PEM="/home/${{ secrets.REMOTE_USER }}/chavetmp.pem"
            rm -f $ARQUIVO_PEM
            echo "${{ secrets.EC2_SSH_KEY }}" > $ARQUIVO_PEM
            chmod 400 $ARQUIVO_PEM

            # Variáveis
            USUARIO_IP="ec2-user@${{ secrets.REMOTE_HOST_PRIVADO }}"
            USUARIO_BACKEND="ec2-user"
            DIRETORIO_API="/home/$USUARIO_BACKEND/backend/api"

            # NOTA: O conteúdo do Base64 deve ser passado para o SSH de forma segura.
            # Vamos manter a variável ENV_FILE_API codificada.
            ENCODED_ENV_FILE="${{ secrets.ENV_FILE_API }}"
            
            # Use 'rm -rf' para garantir que se for um diretório (.env) ele seja removido
            ssh -o StrictHostKeyChecking=no -i $ARQUIVO_PEM $USUARIO_IP "
              sudo mkdir -p $DIRETORIO_API &&
              sudo chown -R ec2-user:ec2-user /home/ec2-user/backend &&
              sudo chmod -R 755 /home/ec2-user/backend
            "

            echo "==> Parando serviços (API, RabbitMQ, Redis)"
            # ... (demais comandos de parada) ...

            echo '==> Enviando novo app_loko.jar...'
            # ... (comando scp) ...

            echo "==> Enviando .env via Base64 (NOVO MÉTODO)"
            # Constrói o comando de decodificação no servidor remoto
            # Usa 'echo' local com o Base64, pipe para 'ssh' (que executa 'base64 --decode > .env')
            
            # 1. Remove o objeto, seja ele arquivo ou diretório
            ssh -o StrictHostKeyChecking=no -i $ARQUIVO_PEM $USUARIO_IP "
              rm -rf $DIRETORIO_API/.env || true
            "
            
            # 2. Envia a string Base64 e a decodifica no servidor privado
            # Note o uso de aspas simples para proteger $ENCODED_ENV_FILE na EC2 pública
            echo '$ENCODED_ENV_FILE' | ssh -o StrictHostKeyChecking=no -i $ARQUIVO_PEM $USUARIO_IP "
              base64 --decode > $DIRETORIO_API/.env
            "
            
            echo "==> Verificando arquivo e permissões..."
            ssh -o StrictHostKeyChecking=no -i $ARQUIVO_PEM $USUARIO_IP "
              # Define permissões no arquivo recém-criado
              chmod 644 $DIRETORIO_API/.env
              
              # Verifica se é um arquivo (e não um diretório 'd')
              if [ -f \"$DIRETORIO_API/.env\" ]; then
                echo '✅ .env criado com sucesso como ARQUIVO!'
                echo 'Conteúdo (apenas as primeiras linhas):'
                head $DIRETORIO_API/.env
              else
                echo '❌ Erro: Objeto .env não é um arquivo. Verifique o Base64.'
                # Saída para falhar a action
                exit 1
              fi
            "

            echo "==> Subindo serviços (API, RabbitMQ, Redis)"
            ssh -o StrictHostKeyChecking=no -i $ARQUIVO_PEM $USUARIO_IP "
              cd /home/ec2-user &&
              sudo docker-compose up -d
            "

            echo "==> Deploy finalizado com sucesso!"
