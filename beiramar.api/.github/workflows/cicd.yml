name: CI/CD para EC2 pÃºblica e privada

on:
  push:
    branches:
      - master # O branch que acionarÃ¡ o deploy
  workflow_dispatch: # Permite execuÃ§Ã£o manual do workflow
    inputs:
      environment:
        description: 'Ambiente para deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development
      skip_tests:
        description: 'Pular testes?'
        required: false
        default: true
        type: boolean
      force_restart:
        description: 'ForÃ§ar restart mesmo se nÃ£o houver mudanÃ§as?'
        required: false
        default: false
        type: boolean

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      # 0. Exibir informaÃ§Ãµes do trigger
      - name: ğŸ“‹ InformaÃ§Ãµes do Deploy
        run: |
          echo "ğŸš€ ========================================="
          echo "ğŸ“ RepositÃ³rio: ${{ github.repository }}"
          echo "ğŸ“Œ Branch: ${{ github.ref_name }}"
          echo "ğŸ”— Trigger: ${{ github.event_name }}"
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ğŸ® EXECUÃ‡ÃƒO MANUAL"
            echo "  â€¢ Ambiente: ${{ github.event.inputs.environment }}"
            echo "  â€¢ Pular testes: ${{ github.event.inputs.skip_tests }}"
            echo "  â€¢ ForÃ§ar restart: ${{ github.event.inputs.force_restart }}"
          else
            echo "âš™ï¸ EXECUÃ‡ÃƒO AUTOMÃTICA (Push)"
          fi
          
          echo "âœ¨ ========================================="

      # 1. Checkout do repositÃ³rio
      - name: BE - Checkout do CÃ³digo
        uses: actions/checkout@v4

      # 2. Configurar JDK
      - name: BE - Configurar JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'
          cache-dependency-path: 'beiramar.api/pom.xml'
      
      # 3. Configurar variÃ¡veis de ambiente no application.properties
      - name: BE - Configurar Banco de Dados e CORS no application.properties
        run: |
          # Substitui URL do banco de dados para apontar para a EC2 privada
          sed -i "s|^spring.datasource.url=.*|spring.datasource.url=jdbc:mysql://${{ secrets.DB_HOST }}:3306/beiramar?useSSL=false\&allowPublicKeyRetrieval=true|g" src/main/resources/application.properties
          
          echo "âœ… Database URL configurado para: jdbc:mysql://${{ secrets.DB_HOST }}:3306/beiramar"
          
          # Substitui CORS origins para aceitar requisiÃ§Ãµes do ALB (DNS pÃºblico do ALB)
          sed -i "s|^cors.allowed.origins=.*|cors.allowed.origins=http://${{ secrets.ALB_DNS_NAME }}|g" src/main/resources/application.properties
          
          echo "âœ… CORS configurado para: http://${{ secrets.ALB_DNS_NAME }}"
          
          # Mostra as linhas modificadas para confirmar
          echo "ConfiguraÃ§Ãµes aplicadas:"
          grep "cors.allowed.origins" src/main/resources/application.properties
          grep "spring.datasource.url" src/main/resources/application.properties
        working-directory: ./beiramar.api

      # 4. Gerar Artefato .JAR
      - name: BE - Gerar Artefato .JAR
        run: mvn package -DskipTests=true
        working-directory: ./beiramar.api

      # 5. Renomear JAR para nome fixo
      - name: BE - Renomear JAR para beiramar-api.jar
        run: |
          JAR_NAME=$(ls target/*.jar)
          mv $JAR_NAME target/beiramar-api.jar
          echo "Renomeado para: target/beiramar-api.jar"
        working-directory: ./beiramar.api

      # 6. Copiar JAR para EC2 privada via SCP
      - name: BE - Copiar JAR para EC2 privada
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.BACKEND_HOST }}
          username: ${{ secrets.BACKEND_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "./beiramar.api/target/beiramar-api.jar"
          target: "/tmp/"
          strip_components: 3

          # 7. Transferir JAR e reiniciar aplicaÃ§Ã£o
      - name: BE - Transferir JAR e reiniciar aplicaÃ§Ã£o no Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_HOST }}
          username: ${{ secrets.BACKEND_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            
            echo "ğŸ“¦ Verificando arquivo copiado..."
            ls -lh /tmp/beiramar-api.jar
            
            echo "ğŸš€ Movendo JAR para o diretÃ³rio de aplicaÃ§Ã£o..."
            sudo mv /tmp/beiramar-api.jar /usr/share/api/beiramar-api.jar
            sudo chmod 644 /usr/share/api/beiramar-api.jar
            
            echo "ğŸ›‘ Parando containers..."
            cd /home/ubuntu
            sudo docker-compose -f compose.yaml down 2>/dev/null || true
            
            echo "ğŸ”„ Recriando e iniciando containers com novo JAR..."
            sudo docker-compose -f compose.yaml up -d --force-recreate
            
            echo "â³ Aguardando inicializaÃ§Ã£o..."
            sleep 10
            
            echo "âœ… Verificando status dos containers..."
            sudo docker-compose -f compose.yaml ps
            
            echo "ğŸ‰ AplicaÃ§Ã£o reiniciada com sucesso!"
            echo "ğŸ“ Acesse em: http://${{ secrets.ALB_DNS_NAME }}/api"